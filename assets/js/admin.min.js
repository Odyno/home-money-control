/*! HMC - v0.0.1 - 2016-12-04 */
jQuery(document).ready(function(a){var b=window.HMC,c={Models:{},Views:{},noConflict:noConflict=function(){return window.HMC=b,this}};window.HMC=c,c.COUNT_TYPE={SOPRAVVIVENZA:{id:0,label:"Sopravvivenza",color:"#298048"},SERVIZI_OPTIONAL:{id:1,label:"Optional",color:"#ADD8E6"},HOBBIES_TEMPO_LIBERO:{id:2,label:"Hobbies",color:"#FFA500"},IMPREVISTI_EXTRA:{id:3,label:"Imprevisti",color:"#FF0000"},ENTRATE:{id:4,label:"Entrate",color:"#008000"},USCITE_FISSE:{id:5,label:"Uscite",color:"#0000FF"},BUDGET:{id:6,label:"Budget",color:"#ffbc00"},getColor:function(a){return this.SOPRAVVIVENZA.id==a?this.SOPRAVVIVENZA.color:this.SERVIZI_OPTIONAL.id==a?this.SERVIZI_OPTIONAL.color:this.HOBBIES_TEMPO_LIBERO.id==a?this.HOBBIES_TEMPO_LIBERO.color:this.IMPREVISTI_EXTRA.id==a?this.IMPREVISTI_EXTRA.color:this.ENTRATE.id==a?this.ENTRATE.color:this.USCITE_FISSE.id==a?this.USCITE_FISSE.color:void 0},getLabel:function(a){return this.SOPRAVVIVENZA.id==a?this.SOPRAVVIVENZA.label:this.SERVIZI_OPTIONAL.id==a?this.SERVIZI_OPTIONAL.label:this.HOBBIES_TEMPO_LIBERO.id==a?this.HOBBIES_TEMPO_LIBERO.label:this.IMPREVISTI_EXTRA.id==a?this.IMPREVISTI_EXTRA.label:this.ENTRATE.id==a?this.ENTRATE.label:this.USCITE_FISSE.id==a?this.USCITE_FISSE.label:void 0}},c.Models.Count=Backbone.Model.extend({defaults:function(){return{id:null,name:null,description:null,type:null}}}),c.Models.Count_Type=Backbone.Model.extend({defaults:function(){return{id:null,label:null}}}),c.Models.Counts=Backbone.Collection.extend({model:c.Models.Count,url:"/wp-json/hmc/v1/voices"}),c.Models.Report=Backbone.Model.extend(),c.Models.Reports=Backbone.Collection.extend({model:c.Models.Report,url:"/wp-json/hmc/v1/fields"}),c.Models.AllStat=Backbone.Model.extend({defaults:function(){return{from:"2016-10-01",to:"2016-10-31",count:"0",items:[]}},url:"/wp-json/hmc/v1/allstats"}),c.Models.Statistic=Backbone.Model.extend({defaults:function(){return{type:"6",from:"2016-10-01",to:"2016-10-31",count:"0",total:"0",items:[]}},url:"/wp-json/hmc/v1/stats"}),c.Models.TransactionStat=Backbone.Model.extend({defaults:function(){return{from:"2016-11-01",to:"2016-11-30",totals:[{total:"0",type:"4"},{total:"0",type:"5"}],avgs:[{avg:"0",type:"0"},{avg:"0",type:"1"},{avg:"0",type:"2"},{avg:"0",type:"3"},{avg:"0",type:"4"},{avg:"0",type:"5"}]}},url:"/wp-json/hmc/v1/stats/transactions"}),c.Views.CountTableField=Backbone.View.extend({tagName:"li",template:_.template(a("#item-template").html()),events:{"click a.change":function(){this.set_edit_mode(!0)},dblclick:function(){this.set_edit_mode(!0)},"click .close":function(){this.set_edit_mode(!1)},"click a.destroy":"clear_model","change input":"changed","change select":"changed","change textarea":"changed","click a.save":"save"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var a=this.model.toJSON();return this.$el.html(this.template(a)),"unamed"===a.name&&this.set_edit_mode(!0),this},set_edit_mode:function(a){a?this.$el.addClass("editing"):this.$el.removeClass("editing")},changed:function(b){var c=(b.currentTarget,a(b.currentTarget).val()),d=a(b.currentTarget).attr("name"),e={};e[d]=c,this.model.set(e),this.model.save()},save:function(b){var c=(b.currentTarget,a(b.currentTarget).val()),d=a(b.currentTarget).attr("name"),e={};e[d]=c,this.model.set(e),this.model.save()},clear_model:function(){confirm("Are you sure you want to DELETE this Count from database?")&&this.model.destroy()}}),c.Views.CountsTable=Backbone.View.extend({el:a("#countview"),events:{"click a.create":"createOnCount"},initialize:function(){this.input=this.$("#new-todo"),this.counts=new c.Models.Counts,this.listenTo(this.counts,"add",this.addOne),this.listenTo(this.counts,"remove",this.notifyRemove),this.listenTo(this.counts,"error",this.notifyError),this.listenTo(this.counts,"all",this.render),this.footer=this.$("footer"),this.header=this.$("header"),this.main=a("#main"),this.counts.fetch()},render:function(){this.counts.length?this.main.show():this.main.hide()},notifyRemove:function(){this.header.append('<div class="notice notice-info is-dismissible"><p>Delete Done!</p></div>')},notifyError:function(){this.header.append('<div class="notice notice-warning is-dismissible"><p>Error appears!</p></div>')},addOne:function(a){console.log("called");var b=new c.Views.CountTableField({model:a});this.$("#count-list").prepend(b.render().el)},createOnCount:function(){var a=new c.Models.Count;return a.set({name:"unamed"}),this.counts.create(a)}}),c.Views.ReportView=Backbone.View.extend({el:a("#report_dialog"),events:{"click #hmc-report-ok":"save","click #hmc-report-delete":"destroy","click .hmc-report-cancel":"close","input #hmc_count":"filterCount"},initialize:function(){_.bindAll(this,"render","_sync_ui","_sync_model","open","close","save","destroy"),this.value=null,this.description=null,this.category=null},filterCount:function(){console.log("pippo"),this.filter!=a("#hmc_count").val()&&(this.filter=a("#hmc_count").val(),null!=this.currentRequest&&this.currentRequest.abort(),this.currentRequest=a.ajax({url:"/wp-json/hmc/v1/voices",method:"GET",data:"term="+encodeURIComponent(this.filter),dataType:"json",beforeSend:function(){a("#acc_0").hide(),a("#accordion_0").html(""),a("#acc_1").hide(),a("#accordion_1").html(""),a("#acc_2").hide(),a("#accordion_2").html(""),a("#acc_3").hide(),a("#accordion_3").html(""),a("#acc_4").hide(),a("#accordion_4").html(""),a("#acc_5").hide(),a("#accordion_5").html("")}}).done(function(b){b.forEach(function(b){a("#acc_"+b.type).show(),a("#acc_label_"+b.type).html(c.COUNT_TYPE.getLabel(b.type)),a("#accordion_"+b.type).append("<input type='radio' name='selected_count_id' value='"+b.id+"' ><span class='count_type type_"+b.type+"' ></span> "+b.name+" "+(null!==b.description?b.description:"")+"</input><br><br>")})}))},selectCount:function(b){a("#hmc_count").val(b.name),a("#hmc_count_id").val(b.id),a("#hmc_count_description").html(b.description)},render:function(){return this.open(),this.$el.show(),a("#acc_0").hide(),a("#acc_1").hide(),a("#acc_2").hide(),a("#acc_3").hide(),a("#acc_4").hide(),a("#acc_5").hide(),a("#hmc-report-ok").show(),this.model.isNew()?a("#hmc-report-delete").hide():a("#hmc-report-delete").show(),a(".hmc-report-cancel").show(),a(".hmc-modal-title").text((this.model.isNew()?"New":"Edit")+" Report"),this},_processing:function(a){a?this.$("#hmc-processing").show():this.$("#hmc-processing").hide()},_sync_ui:function(){if(this._processing(!0),this.$("#hmc_value_date").val(this.model.get("value_date")),this.model.isNew())this.$("#hmc_value").val(""),this.$("#hmc_description").val(""),this.$("#hmc_count_id").val("0"),this.$("#hmc_count").val("");else{this.$("#hmc_value").val(this.model.get("value")),this.$("#hmc_description").val(this.model.get("description"));var a=this.model.get("category");this.$("#hmc_count_id").val(a.id),this.$("#hmc_count").val(a.name)}this._processing(!1)},_sync_model:function(){var a={};a.id=this.$("#hmc_count_id").val();var b={};b.value_date=this.$("#hmc_value_date").val(),b.posting_date=moment().toISOString(),b.value=this.$("#hmc_value").val(),b.category=a,b.description=this.$("#hmc_description").val(),this.model.set(b)},open:function(){this._sync_ui()},close:function(){this._processing(!1),this.$el.hide()},save:function(){this._sync_model(),this._processing(!0),this.model.isNew()?this.collection.create(this.model,{success:this.close}):this.model.save({},{success:this.close})},destroy:function(){confirm("Are you sure you want to DELETE this Count from database?")&&this.model.destroy({success:this.close})},onEdit:function(a){this.model=a,this.render()},onNew:function(a,b){this.collection=b,this.model=new c.Models.Report({value_date:a}),this._sync_ui(),this.render()}}),c.Views.Calendar=Backbone.View.extend({tag:"div",events:{"click .hmc-caledar-new-report":"onNew"},el:a("#hmc_calendar"),initialize:function(){this.collection=new c.Models.Reports,_.bindAll(this,"render","select","_addOne","_addAll","eventClick","_fetch_events"),this.listenTo(this.collection,"reset",this._addAll),this.listenTo(this.collection,"add",this._addOne),this.listenTo(this.collection,"change",this._change),this.listenTo(this.collection,"destroy",this._destroy),this.reportView=new c.Views.ReportView},render:function(){this.$el.fullCalendar({header:{left:"prev,next today",center:"title",right:"basicWeek,month"},lang:navigator.language||navigator.userLanguage,eventLimit:!0,defaultView:"basicWeek",selectable:!0,selectHelper:!0,editable:!0,ignoreTimezone:!1,select:this.select,eventClick:this.eventClick,events:this._fetch_events})},_fetch_events:function(b,c){var d={from:b.format("YYYY-MM-DD HH:mm:ss"),to:c.format("YYYY-MM-DD HH:mm:ss"),type:"0,1,2,3"};this.collection.fetch({reset:!0,data:a.param(d)})},eventClick:function(a){this.reportView.onEdit(this.collection.get(a.id))},eventDropOrResize:function(a){this.collection.get(a.id).save({start:a.start,end:a.end})},onNew:function(){console.log("pluto"),this.select(moment(),null,null)},select:function(a){this.reportView.onNew(a,this.collection)},_addAll:function(){var a=this.collection.toJSON();a.forEach(function(a){return function(b){0!=a._format_object(b)&&a.$el.fullCalendar("renderEvent",b)}}(this))},_addOne:function(a){var b=a.toJSON();0!=this._format_object(b)&&this.$el.fullCalendar("renderEvent",b)},_format_object:function(a){var b;return null==("undefined"!=typeof a&&null!==a&&null!=(b=a.category)?b.name:void 0)?(console.log("scartato",a),!1):(a.title=a.value+" € "+a.category.name,a.start=a.value_date,a.allDay=!0,void(a.className="count_type type_"+a.category.type))},_change:function(a){var b=this.$el.fullCalendar("clientEvents",a.get("id"))[0];0!=this._format_object(b)&&(this.$el.fullCalendar("updateEvent",b),this.$el.fullCalendar("refetchEvents"))},_destroy:function(a){this.$el.fullCalendar("removeEvents",a.id)}}),c.Views.PieChart=Backbone.View.extend({elementId:null,iChart:null,chartId:null,dataset:null,count_name:null,count_type:null,title:null,color:null,events:{click:"loadData"},initialize:function(a){return this.elementId=a.id,this.count_name=a.name||"unamed",this.count_type=a.type_id||"0",this.color=a.color||"#"+(Math.random().toString(16)+"0000000").slice(2,8),this.model=new c.Models.Statistic,this.listenTo(this.model,"reset",this.update),this.listenTo(this.model,"add",this.update),this.listenTo(this.model,"change",this.update),this.listenTo(this.model,"destroy",this.update),this.loadData(),this},loadData:function(){this.model.fetch({url:"/wp-json/hmc/v1/stats/"+this.count_type})},update:function(){this.parseData(this.model.toJSON()),this.render()},parseData:function(a){var b=[],c=[],d=[],e=[];a.items.forEach(function(f){b.push(f.name),c.push(f.total),d.push(this.change_brightness(this.color,100-100*f.total/a.total)),e.push("#eeeeee")},this),0==c.length&&(b.push("none"),c.push(0),d.push("#efefef"),e.push("#eeeeee")),this.dataset={labels:b,datasets:[{data:c,backgroundColor:d,borderColor:e}]},this.title=this.count_name+" € "+a.total},change_brightness:function(a,b){a=a.replace(/^\s*#|\s*$/g,""),3==a.length&&(a=a.replace(/(.)/g,"$1$1"));var c=parseInt(a.substr(0,2),16),d=parseInt(a.substr(2,2),16),e=parseInt(a.substr(4,2),16);return"#"+(0|256+c+(256-c)*b/100).toString(16).substr(1)+(0|256+d+(256-d)*b/100).toString(16).substr(1)+(0|256+e+(256-e)*b/100).toString(16).substr(1)},render:function(){var a=this,b={responsive:!0,padding:2,legend:{display:!1},title:{display:!0,text:this.title},onClick:function(){a.loadData()}},c=document.getElementById(this.elementId).getContext("2d");return this.iChart=new Chart(c,{type:"doughnut",data:this.dataset,options:b}),this}}),c.Views.ReportTableField=Backbone.View.extend({tagName:"tr",events:{"click .hmc-delete-report":"destroy","click .hmc-edit-report":""},initialize:function(){_.bindAll(this,"render"),this.model.bind("change",this.render)},destroy:function(){confirm("Are you sure you want to DELETE this Count from database?")&&this.model.destroy()},render:function(){return this.$el.empty(),this.$el.addClass("type_"+this.model.get("category").type),this.$el.append(a("<td>"+moment(this.model.get("value_date")).fromNow()+"</td>")),this.$el.append(a("<td>"+this.model.get("category").name+"</td>")),this.$el.append(a("<td>"+this.model.get("description")+"</td>")),this.$el.append(a('<td> <span class="enMoney">'+this.model.get("value")+'</span> <a class="alignright hmc-delete-report" ><span class="dashicons dashicons-trash"></span></a></td>')),this}}),c.Views.ReportTable=Backbone.View.extend({collection:null,template:_.template(a("#transaction-table-template").html()),_me:this,events:{"click .hmc-add-report":"onNew","click .hmc-refresh-report":"onRefresh","click .hmc-last-mount-report":"onStepBefore","click .hmc-next-mount-report":"onStepAfter","click .hmc-this-mount-report":"onMoveToday"},initialize:function(a){this._elementID=a.id,this.collection=new c.Models.Reports,this.editor=new c.Views.ReportView,this.categories=a.category,_.bindAll(this,"render"),this.collection.bind("reset",this.render),this.collection.bind("add",this.render),this.collection.bind("remove",this.render),this.collection.bind("change",this.render),this.collection.bind("destroy",this.render),this.collection.bind("error",this.render),this.onMoveToday()},onStepBefore:function(){this.startDate=moment(this.startDate).subtract(1,"month").startOf("month"),this.endDate=moment(this.endDate).subtract(1,"month").endOf("month"),this.onRefresh()},onStepAfter:function(){this.startDate=moment(this.startDate).add(1,"month").startOf("month"),this.endDate=moment(this.endDate).add(1,"month").endOf("month"),this.onRefresh()},onMoveToday:function(){this.startDate=moment().startOf("month"),this.endDate=moment().endOf("month"),this.onRefresh()},onRefresh:function(){"use strict";this.loadData()},loadData:function(){var b={from:this.startDate.format("YYYY-MM-DD HH:mm:ss"),to:this.endDate.format("YYYY-MM-DD HH:mm:ss"),type:this.categories};this.collection.fetch({reset:!0,data:a.param(b)})},onNew:function(){this.editor.onNew(moment(),this.collection)},updateRage:function(a,b){this.startDate=a,this.endDate=b,this.loadData()},render:function(){this.$el.html(this.template()),this.$el.find("#reportrange").html(this.startDate.format("MMMM YYYY"));var a=this.$el.find("#hmc_table_content");a.empty();var b=0;return this.collection.forEach(function(d){var e=new c.Views.ReportTableField({model:d});a.append(e.render().el),b+=d.get("value")}),this.$el.find("#hmc_table_summ").append(b),this}}),c.Views.BudgetView=Backbone.View.extend({events:{"click .hmc-refresh-report":"onRefresh","click .hmc-last-mount-report":"onStepBefore","click .hmc-next-mount-report":"onStepAfter","click .hmc-this-mount-report":"onMoveToday"},initialize:function(){this.model=new c.Models.TransactionStat,this.startDate=moment().startOf("month"),this.endDate=moment().endOf("month"),this.moptions={legend:{position:"right"},scale:{ticks:{beginAtZero:!0}}},this.listenTo(this.model,"sync",this.update),this.loadData()},onStepBefore:function(){this.startDate=moment(this.startDate).subtract(1,"month").startOf("month"),this.endDate=moment(this.endDate).subtract(1,"month").endOf("month"),this.onRefresh()},onStepAfter:function(){this.startDate=moment(this.startDate).add(1,"month").startOf("month"),this.endDate=moment(this.endDate).add(1,"month").endOf("month"),this.onRefresh()},onMoveToday:function(){this.startDate=moment().startOf("month"),this.endDate=moment().endOf("month"),this.onRefresh()},onRefresh:function(){this.loadData()},loadData:function(){var b={from:this.startDate.format("YYYY-MM-DD HH:mm:ss"),to:this.endDate.format("YYYY-MM-DD HH:mm:ss"),type:this.categories};this.model.fetch({reset:!0,data:a.param(b)})},update:function(){this.parseData(this.model.toJSON()),this.render()},parseData:function(a){for(var b=[],d=0;6>d;d++)b[d]={label:c.COUNT_TYPE.getLabel(d),avg:0,budget:0,total:0};a.avgs.forEach(function(a){b[a.type].avg=a.avg},this),a.totals.forEach(function(a){b[a.type].total=a.total},this),this.dataset={labels:[b[0].label,b[1].label,b[2].label,b[3].label,b[5].label],datasets:[this._formatData("Dati","54, 162, 235",[b[0].total,b[1].total,b[2].total,b[3].total,b[5].total]),this._formatData("Media","75, 192, 192",[b[0].avg,b[1].avg,b[2].avg,b[3].avg,b[5].avg]),this._formatData("Budget","255, 99, 132",[b[0].budget,b[1].budget,b[2].budget,b[3].budget,b[5].budget])]},console.log(this.dataset)},_formatData:function(a,b,c){return{label:a,backgroundColor:"rgba("+b+", 0.2)",borderColor:"rgba("+b+", 1)",pointBackgroundColor:"rgba("+b+", 1)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"rgba("+b+",1)",data:c}},render:function(){var a=this.$el.find("#mouth_budget");this.$el.find("#stat_range").html(this.startDate.format("MMMM YYYY"));new Chart(a,{type:"bar",data:this.dataset,options:this.moptions})}})});